<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Innovation and Technology Transfer at UWC</title>

  <!-- TTO site stylesheet -->
  <link rel="stylesheet" href="/assets/css/tto.css">
 
  <!--Bootstrap-->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
      .card {
        transition: transform 0.2s;
      }
      .card:hover {
        transform: translateY(-5px);
      }
      .card-title {
        line-height: 1.4;
      }
      .card-text {
        line-height: 1.6;
      }
      .btn-primary {
        background-color: #002b5c;
        border-color: #002b5c;
      }
      .btn-primary:hover {
        background-color: #001f43;
        border-color: #001f43;
      }
    </style>
</head>
<body>
  <!-- ===== HEADER / NAVBAR ===== -->
  <div id="header"></div>
    <script src="/assets/js/loadHeader.js"></script>

  <!-- ===== BREADCRUMB ===== -->
  <div id="breadcrumb-placeholder"></div>

    <script>
      fetch('./components/breadcrumb.html')
        .then(r => r.text())
        .then(html => {
          document.getElementById('breadcrumb-placeholder').innerHTML = html;

          // load the breadcrumb generator script and run it when ready
          const s = document.createElement('script');
          s.src = './assests/js/generateBreadcrumb.js';
          s.onload = () => { if (window.generateBreadcrumb) window.generateBreadcrumb('site-breadcrumb'); };
          document.body.appendChild(s);
        })
        .catch(err => console.error('breadcrumb load:', err));
    </script>

    <div class="container my-5">
        <!-- Search Bar -->
        <div class="row mb-4">
            <div class="col-md-6 mx-auto">
                <div class="input-group">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search news...">
                    <button class="btn btn-primary" type="button" id="searchButton">
                        Search
                    </button>
                </div>
            </div>
        </div>
        <!-- Main Content -->
        <div class="row justify-content-center">
        </div>
    </div>
    <!-- ===== FOOTER ===== -->
      <div id="footer"></div>
      <script>
       fetch('./components/footer.html')
        .then(res => res.text())
        .then(data => document.getElementById('footer').innerHTML = data);
      </script>

   <!--=== Scripts ===-->
    <script>
      const ITEMS_PER_PAGE = 10;
      let currentPage = 1;
      let allNews = [];
      let filteredNews = [];

      window.handleNewsData = function(news) {
        console.log('Received news data:', news);
        
        if (!news || news.length === 0) {
            document.querySelector('.row.justify-content-center').innerHTML = 
              '<div class="col-12 text-center"><p>No news items available.</p></div>';
            return;
        }

        try {
            allNews = news.sort((a, b) => new Date(b.Date) - new Date(a.Date));
            filteredNews = [...allNews];
            
            // Initial render
            renderNewsPage(currentPage);
            renderPagination();
            
            // Set up search functionality
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');

            function performSearch() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                filteredNews = allNews.filter(item => 
                    item.Title?.toLowerCase().includes(searchTerm) || 
                    item.Summary?.toLowerCase().includes(searchTerm)
                );
                currentPage = 1;
                renderNewsPage(currentPage);
                renderPagination();
            }

            searchButton.addEventListener('click', performSearch);
            searchInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') performSearch();
            });

        } catch (error) {
            console.error('Error processing news:', error);
            document.querySelector('.row.justify-content-center').innerHTML = 
              '<div class="col-12 text-center"><p>Error processing news data.</p></div>';
        }
      };

      function renderNewsPage(page) {
        const container = document.querySelector('.row.justify-content-center');
        container.innerHTML = '';
        
        if (filteredNews.length === 0) {
            container.innerHTML = '<div class="col-12 text-center"><p>No matching news items found.</p></div>';
            return;
        }
        
        const startIndex = (page - 1) * ITEMS_PER_PAGE;
        const endIndex = startIndex + ITEMS_PER_PAGE;
        const pageItems = filteredNews.slice(startIndex, endIndex);
        
        pageItems.forEach(item => {
            const div = document.createElement('div');
            div.className = 'col-12 mb-5';
            div.innerHTML = `
                <div class="card border-0">
                    <div class="row g-0">
                        <div class="col-md-6">
                            ${item.ImageURL ? 
                                `<img src="${item.ImageURL}" 
                                    class="img-fluid rounded" 
                                    alt="${item.Title}"
                                    style="width: 100%; height: 400px; object-fit: cover;">` : 
                                ''}
                        </div>
                        <div class="col-md-6 d-flex align-items-center">
                            <div class="card-body p-4">
                                <h2 class="card-title h3 mb-3" style="color: #002b5c; font-weight: 600;">
                                    ${item.Title}
                                </h2>
                                <p class="card-text text-muted mb-2">
                                    ${item.Date ? new Date(item.Date).toLocaleDateString('en-US', {
                                        year: 'numeric',
                                        month: 'long',
                                        day: 'numeric'
                                    }) : ''}
                                </p>
                                <p class="card-text">${item.Summary}</p>
                                ${item.URL ? 
                                    `<a href="${item.URL}" class="btn btn-primary mt-3">Read more</a>` : 
                                    ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(div);
        });
      }

      function renderPagination() {
        const totalPages = Math.ceil(filteredNews.length / ITEMS_PER_PAGE);
        
        if (totalPages <= 1) return;

        const container = document.querySelector('.row.justify-content-center');
        const paginationDiv = document.createElement('div');
        paginationDiv.className = 'col-12';
        paginationDiv.innerHTML = `
            <nav aria-label="News pagination">
                <ul class="pagination justify-content-center">
                    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
                    </li>
                    ${Array.from({ length: totalPages }, (_, i) => i + 1)
                        .map(pageNum => `
                            <li class="page-item ${pageNum === currentPage ? 'active' : ''}">
                                <a class="page-link" href="#" data-page="${pageNum}">${pageNum}</a>
                            </li>
                        `).join('')}
                    <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
                    </li>
                </ul>
            </nav>
        `;

        container.appendChild(paginationDiv);

        document.querySelectorAll('.pagination .page-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const newPage = parseInt(e.target.dataset.page);
                if (newPage && newPage !== currentPage && newPage > 0 && newPage <= totalPages) {
                    currentPage = newPage;
                    renderNewsPage(currentPage);
                    renderPagination();
                }
            });
        });
      }

      // Initialize news loading
      const script = document.createElement('script');
      const baseUrl = 'https://script.google.com/macros/s/AKfycby1YngYPcv0vcaEUcaGyQPup1aY3Z24ZgWypYXcJ0AsB3f7FJWmZFBzael4-0xK4nSE/exec';
      const url = new URL(baseUrl);
      url.searchParams.append('callback', 'handleNewsData');
      url.searchParams.append('page', 'news'); // ADD THIS LINE
      script.src = url.toString();
      script.async = true;
      script.onerror = (error) => {
          console.error('Script loading error:', error);
          document.querySelector('.row.justify-content-center').innerHTML = 
              '<div class="col-12 text-center"><p>Could not load news. Please try again later.</p></div>';
      };
      console.log('Fetching from URL:', url.toString()); // ADD THIS DEBUG LINE
      document.body.appendChild(script);
    </script>

    <!-- Bootstrap bundle is injected centrally by the header component -->
    <script src="./assets/js/load-navbar.js"></script>
    <script src="./assets/js/loadFooter.js"></script>
</body>
</html>
